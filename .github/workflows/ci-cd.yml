name: Test Execution and Reporting

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven

      - name: Run Tests
        id: test
        run: |
          mvn test -DfailIfNoTests=true || true
          echo "::set-output name=exit_code::$?"

      - name: Generate Test Report
        if: always()
        run: |
          echo "# Test Execution Report" > test-report.txt
          echo "Date: $(date)" >> test-report.txt
          echo "" >> test-report.txt
          
          echo "## Test Summary" >> test-report.txt
          total=$(grep -c "Tests run:" target/surefire-reports/*.txt)
          failures=$(grep -c "FAILURE" target/surefire-reports/*.txt || echo "0")
          passed=$((total - failures))
          echo "- Total Tests: $total" >> test-report.txt
          echo "- Passed: $passed" >> test-report.txt
          echo "- Failed: $failures" >> test-report.txt
          echo "" >> test-report.txt
          
          echo "## Failed Tests Details" >> test-report.txt
          echo "" >> test-report.txt
          
          # Extract Book API Test Failures
          echo "### Book API Tests" >> test-report.txt
          echo "#### GET Endpoints" >> test-report.txt
          grep -B1 -A1 "GetBookAPI.*FAILED" target/surefire-reports/*.txt | sed 's/^/    /' >> test-report.txt
          echo "" >> test-report.txt
          
          echo "#### PUT Endpoints" >> test-report.txt
          grep -B1 -A1 "PutBookAPI.*FAILED" target/surefire-reports/*.txt | sed 's/^/    /' >> test-report.txt
          echo "" >> test-report.txt
          
          # Extract UI Test Failures
          echo "### UI Tests" >> test-report.txt
          grep -B1 -A1 "BuggyCarsUI.*FAILED" target/surefire-reports/*.txt | sed 's/^/    /' >> test-report.txt
          echo "" >> test-report.txt
          
          # Add error details
          echo "## Detailed Error Messages" >> test-report.txt
          echo '```' >> test-report.txt
          grep -A 3 "^Running.*Test" target/surefire-reports/*.txt | grep -B 2 "FAILURE" >> test-report.txt
          echo '```' >> test-report.txt

      - name: Send Email Report
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Test Results: ${{ job.status == 'success' && 'PASSED ✅' || 'FAILED ❌' }}"
          to: sasitharanvaratharasa887@gmail.com
          from: GitHub Actions
          body: file://test-report.txt
          content_type: text/markdown

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-report
          path: |
            test-report.txt
            target/surefire-reports/

      - name: Check Test Results
        if: steps.test.outputs.exit_code != '0'
        run: exit 1